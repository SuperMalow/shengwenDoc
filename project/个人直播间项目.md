# 个人直播间的搭建

本文主要讲解如何搭建一个属于个人的直播间，利用 OBS 来进行推流到云服务器，接着通过 flv.js 来进行直播的观看。

## 安装 rtmp 模块的 nginx

1. 安装编译依赖

```shell
apt-get update
apt-get install wget git vim -y
apt-get install -y build-essential libpcre3 libpcre3-dev zlib1g zlib1g-dev libssl-dev
```

2. 下载 nginx 源码和 rtmp 模块源码

```shell
wget https://nginx.org/download/nginx-1.24.0.tar.gz
tar -zxvf nginx-1.24.0.tar.gz

# 下载RTMP模块
git clone https://github.com/arut/nginx-rtmp-module.git
```

3. 编译安装

```shell
cd nginx-1.24.0
# 配置
./configure --prefix=/usr/local/nginx --with-http_ssl_module --add-module=../nginx-rtmp-module
# 编译
make
# 安装
make install
```

4. 添加软链接

```shell
ln -s /usr/local/nginx/sbin/nginx /usr/local/bin/nginx
```

5. 测试 nginx 是否安装成功

```shell
nginx -v
```

6. 启动 nginx

```shell
nginx
```

## nginx 配置

在 `/usr/local/nginx/conf/nginx.conf` 中添加如下配置

```nginx
# rtmp and http are of the same level
rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        allow play all;

        application live {
            live on; # start a live stream
            #on_publish 127.0.0.1/auth
        }
    }
}
```

## 个人直播间的权限控制

完成了以上的操作，确实是可以实现个人直播间的功能，但是这样会出现一个问题，假设我们的 IP 地址出现了泄漏，那么谁都可以进行推流，都不用去尝试就会知道会出现大问题。所以我们需要对直播进行一个权限的验证。

经过我反复的考究，终于解决了如何通过不同的密钥来进行推流直播，以下是我的解决方法：

1. 使用任意语言的 web 框架，针对某一个端口下的某一个路径进行监听 post 请求方法
2. 针对该 post 方法，获取其 query_param 参数，针对某些策略来进行验证
3. 验证成功返回 200 状态码即可，验证失败返回 403 状态码即可

具体的实现思路：

1. 专门编写一个后端来负责管理员账号的登录
2. 管理员登录成功后，请求 api 生成随机密钥/获取密钥(密钥存入数据库当中)
3. 后端根据推流传来的 query_param 参数是否跟密钥一致，成功返回 200 状态码，失败返回其他错误状态码即可

## (番外) 制作个人直播间 docker 镜像

**前提**: 以上所有操作均在 docker 拉取的 ubuntu 镜像中进行

1. 将当前容器保存为镜像

```shell
# 查看当前容器ID
docker ps
# 将容器保存为镜像
docker commit 容器ID liveserver
```

2. 将镜像保存为 tar 文件

```shell
docker save -o liveserver.tar liveserver
```

3. 上传镜像到云服务器后，导入镜像

```shell
# 省略上传到云服务器的步骤 scp .....
docker load -i liveserver.tar
```

4. 启动镜像

```shell
docker run -it --name live -p 1935:1935 liveserver:latest /bin/bash
```

5. 启动 nginx (该步可以在写进 systemd 中开机自启，详细请百度)

```shell
nginx
```

## 实战

1. 将制作好的 liveserer 上传到安装好 docker 的服务器

```shell
scp liverserver.tar root@xxx.xxx.xxx.xxx:
```

2. 将上传好的服务器导入镜像并创建容器

```shell
# 导入镜像
docker load -i liveserver.tar
# 创建容器并运行
docker run -it --name live -p 1935:1935 liveserver:latest /bin/bash
```

3. 上传 django 代码到安装好的 docker 服务器

## 上线实战

首先安装 rtmp 模块仍然跟上面的教程一致。

```shell
apt-get update
# 安装工具
apt-get install wget git vim -y
# 安装依赖
apt-get install -y build-essential libpcre3 libpcre3-dev zlib1g zlib1g-dev libssl-dev
# 下载nginx源码
wget https://nginx.org/download/nginx-1.24.0.tar.gz
# 解压
tar -zxvf nginx-1.24.0.tar.gz
# 下载RTMP模块
git clone https://github.com/arut/nginx-rtmp-module.git
# 进入目录
cd nginx-1.24.0
# 配置
./configure --prefix=/usr/local/nginx --with-http_ssl_module --add-module=../nginx-rtmp-module
# 编译
make
# 安装
make install
# 添加软连接
ln -s /usr/local/nginx/sbin/nginx /usr/local/bin/nginx
# 启动
nginx
```

接着添加 nginx.conf 文件配置，首先新增`rtmp`块，该模块与`http`块同级：

```nginx
rtmp {
    server {
        listen 1935;
	chunk_size 4096;
	allow play all;

	ping 30s;
	ping_timeout 10s;

	application live {
	    live on; # start live
	    hls on;
	    hls_path /tmp/hls;
	    hls_fragment 1s;
	    hls_playlist_length 3s;
	    hls_sync 100ms;
	    hls_continuous off;
	    hls_cleanup on;
	    hls_nested on;
#	    on_publish http://localhost/api/livekeys/verifyKey;
#	    on_publish http://localhost:8000/api/livekeys/verifyKey;
#	    on_publish http://localhost:8000/api/livekeys/verifyKey?key=$args;
	    on_publish http://localhost:9000/api/livekeys/verifyKey;
	}
    }
}
```

接着在`http`块新增以下内容：

```nginx
location ^~ / {
	root /www/front/dist;
    try_files $uri $uri/ /index.html;
}

location /api {
    include /usr/local/nginx/conf/uwsgi_params;
    uwsgi_pass 127.0.0.1:8000;
    uwsgi_read_timeout 60;
    #proxy_pass http://127.0.0.1:8000;
}

location /assest {
    alias /www/front/dist/assets;
}

location /media/ {
    alias /var/back/live/media/;
}

location /hls {
    types {
    application/vnd.apple.mpegurl m3u8;
    video/mp2t ts;
    }
        root /tmp;
    add_header 'Cache-Control' 'no-che';
    add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
}
```

```nginx
0 upgraded, 0 newly installed, 0 to remove and 3 not upgraded.
root@4f1e80f5bee9:/www/back# apt-get install python3-pip
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
python3-pip is already the newest version (24.0+dfsg-1ubuntu1.2).
0 upgraded, 0 newly installed, 0 to remove and 3 not upgraded.
root@4f1e80f5bee9:/www/back# python3
Python 3.12.3 (main, Jun 18 2025, 17:59:45) [GCC 13.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> exit
Use exit() or Ctrl-D (i.e. EOF) to exit
>>> exit()
root@4f1e80f5bee9:/www/back# pip3 instsall -r requirements.txt
ERROR: unknown command "instsall" - maybe you meant "install"
root@4f1e80f5bee9:/www/back# pip3 install -r requirements.txt
error: externally-managed-environment

× This environment is externally managed
╰─> To install Python packages system-wide, try apt install
    python3-xyz, where xyz is the package you are trying to
    install.

    If you wish to install a non-Debian-packaged Python package,
    create a virtual environment using python3 -m venv path/to/venv.
    Then use path/to/venv/bin/python and path/to/venv/bin/pip. Make
    sure you have python3-full installed.

    If you wish to install a non-Debian packaged Python application,
    it may be easiest to use pipx install xyz, which will manage a
    virtual environment for you. Make sure you have pipx installed.

    See /usr/share/doc/python3.12/README.venv for more information.

note: If you believe this is a mistake, please contact your Python installation or OS distribution provider. You can override this, at the risk of breaking your Python installation or OS, by passing --break-system-packages.
hint: See PEP 668 for the detailed specification.

                                                                                         0:docker*Z                                                                                             12:17:38 Mon 08-11
```
